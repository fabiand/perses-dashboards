- kind: Dashboard
  metadata:
    name: memory-overcommit
    project: {{PROJECT}}
  spec:
    display:
        name: Memory overcommit
    variables:
        - kind: ListVariable
          spec:
            display:
                name: Node
                hidden: false
            defaultValue: $__all
            allowAllValue: true
            allowMultiple: false
            customAllValue: .*
            sort: alphabetical-ci-asc
            plugin:
                kind: PrometheusLabelValuesVariable
                spec:
                    datasource:
                        kind: PrometheusDatasource
                        name: default
                    labelName: node
            name: node
        - kind: TextVariable
          spec:
            display:
                name: role
                hidden: true
            value: worker
            name: role
    panels:
        MemoryPlanAndUtilization:
            kind: Panel
            spec:
                display:
                    name: Cluster Utilization & Plan - Summary
                    description: The virtual memory assignment is showing the worst-case scenario if all virtual memory was used right now. The assigned virtual memory is shown on top of the non virtualization related memory utilization. The current utiliztaion plus worst-case virtual memory utilization is indiacting the worst case memor overcommittment.
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        legend:
                            position: bottom
                        querySettings:
                            - colorMode: fixed
                              colorValue: '#8f8fff'
                              queryIndex: 0
                            - colorMode: fixed
                              colorValue: '#FFCC00'
                              queryIndex: 1
                            - colorMode: fixed
                              colorValue: '#EE6C6C'
                              queryIndex: 2
                        thresholds:
                            mode: percent
                            steps: []
                        visual:
                            areaOpacity: 0
                            connectNulls: false
                            display: line
                            lineWidth: 1.25
                            pointRadius: 2.75
                        yAxis:
                            format:
                                unit: bytes
                            label: ""
                            min: 0
                            show: true
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                minStep: ""
                                query: sum(kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                seriesNameFormat: Cluster allocatable capacity
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    # all used - system reserved + plan vm
                                    sum(node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    sum(node_memory_MemAvailable_bytes{instance=~"$node"})
                                    -
                                    ( # system reserved
                                    sum(kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum(kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    +
                                    sum(kubevirt_vmi_memory_domain_bytes{node=~"$node"})
                                seriesNameFormat: Plan - VM assigned virtual memory
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    sum(node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    sum(node_memory_MemAvailable_bytes{instance=~"$node"})
                                seriesNameFormat: Utilization - Cluster memory utilization
        OverCommitLevel:
            kind: Panel
            spec:
                display:
                    name: Cluster Committed
                    description: Commit ratio based on the current utilization and allocated virtual memory to VMs. Overcommit occurs whenever the values goes beyond 100%.
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last-number
                        format:
                            unit: percent-decimal
                        sparkline: {}
                        thresholds:
                            steps:
                                - value: 1
                                - color: '#FF9F1C'
                                  value: 1.2
                                - color: '#EA4747'
                                  value: 1.5
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    (
                                    sum(node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    sum(node_memory_MemAvailable_bytes{instance=~"$node"})
                                    -
                                    (
                                    sum(kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum(kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    +
                                    sum(kubevirt_vmi_memory_domain_bytes{node=~"$node"})
                                    )

                                    /

                                    (
                                    sum(kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                seriesNameFormat: Virtual Memory committment
        OverCommitLevel-1:
            kind: Panel
            spec:
                display:
                    name: Virtual Overcommit Level
                    description: Overcommit ratio based on the current utilization and allocated virtual memory to VMs
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last-number
                        format:
                            unit: percent-decimal
                        mappings: []
                        sparkline: {}
                        thresholds:
                            steps:
                                - value: 1.2
                                - color: '#EE6C6C'
                                  value: 1.5
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    (
                                    sum(node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    sum(node_memory_MemAvailable_bytes{instance=~"$node"})
                                    -
                                    (
                                    sum(kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum(kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    +
                                    sum(kubevirt_vmi_memory_domain_bytes{node=~"$node"})
                                    )

                                    /

                                    (
                                    sum(kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                seriesNameFormat: Plan - Virtual Overcomit Level
        PlanMinmax:
            kind: Panel
            spec:
                display:
                    name: Plan - min/max
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        querySettings: []
                        thresholds:
                            steps:
                                - color: '#EE6C6C'
                                  value: 0.9
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    bottomk(1, min by (node) ((

                                    (
                                    (
                                    label_replace((
                                    (node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    (node_memory_MemAvailable_bytes{instance=~"$node"})
                                    ), "node", "$1", "instance", "(.+)")
                                    - on (node)
                                    (
                                    sum by (node) (kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum by (node) (kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    )
                                    +
                                    sum by (node) (kubevirt_vmi_memory_domain_bytes)
                                    )


                                    /

                                    (kube_node_status_allocatable{resource="memory"} * on (node) kube_node_role{role="worker"})

                                    )))
                                seriesNameFormat: '{{node}}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    topk(1, max by (node) ((

                                    (
                                    (
                                    label_replace((
                                    (node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    (node_memory_MemAvailable_bytes{instance=~"$node"})
                                    ), "node", "$1", "instance", "(.+)")
                                    - on (node)
                                    (
                                    sum by (node) (kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum by (node) (kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    )
                                    +
                                    sum by (node) (kubevirt_vmi_memory_domain_bytes)
                                    )


                                    /

                                    (kube_node_status_allocatable{resource="memory"} * on (node) kube_node_role{role="worker"})

                                    )))
                                seriesNameFormat: '{{node}}'
        Pressure:
            kind: Panel
            spec:
                display:
                    name: Cluster - Memory Pressure
                    description: The pressure is indicating if workloads are waiting for memory.
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last-number
                        format:
                            shortValues: true
                            unit: decimal
                        mappings: []
                        sparkline: {}
                        thresholds:
                            steps:
                                - color: '#FF9F1C'
                                  value: 2
                                - value: 4
                                - color: '#EA4747'
                                  value: 6
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: sum(rate(node_pressure_memory_waiting_seconds_total{instance=~"$node"}[1m]))
                                seriesNameFormat: Waiting
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: sum(rate(node_pressure_memory_stalled_seconds_total{instance=~"$node"}[1m]))
                                seriesNameFormat: Stalled
        Pressure-1:
            kind: Panel
            spec:
                display:
                    name: Pressure
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        legend:
                            position: bottom
                        yAxis:
                            format:
                                shortValues: true
                                unit: decimal
                            label: ""
                            max: 2
                            min: 0
                            show: true
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: sum by (instance) (rate(node_pressure_memory_waiting_seconds_total{instance=~"$node"}[1m]))
                                seriesNameFormat: '{{instance}}'
        SystemExceedsResevration:
            kind: Panel
            spec:
                display:
                    name: System exceeding reservation
                    description: This panel provides the number of nodes where the system - core hypervisor components - are exceeding the amount of memory that were reserved for it.
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last-number
                        format:
                            shortValues: true
                            unit: decimal
                        mappings:
                            - kind: Range
                              spec:
                                from: 1
                                result:
                                    color: '#EE6C6C'
                                    value: ""
                        sparkline: {}
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: count by (alertname) (ALERTS{alertname="SystemMemoryExceedsReservation"})
                                seriesNameFormat: '{{alertname}}'
        SystemMinmax:
            kind: Panel
            spec:
                display:
                    name: Utilization - min/max
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        querySettings: []
                        thresholds:
                            steps:
                                - color: '#EE6C6C'
                                  value: 0.9
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    min (
                                    (
                                    sum by (node) (container_memory_rss{id="/system.slice"})

                                    / on (node)

                                    (
                                    sum by (node) (kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum by (node) (kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    )
                                    )
                                seriesNameFormat: min {{node}}
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    max(
                                    sum by (node) (container_memory_rss{id="/system.slice"})

                                    / on (node)

                                    (
                                    sum by (node) (kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum by (node) (kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )

                                    )
                                seriesNameFormat: max {{node}}
        Utilization:
            kind: Panel
            spec:
                display:
                    name: Physical memory utilization & requests
                    description: This is showing the total system utilization (split between virt and non virt workloads). In addition the current plan (requests) are shown in order to to show how much available memory the scheduler is seeing.
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        legend:
                            position: bottom
                        querySettings:
                            - colorMode: fixed
                              colorValue: '#8f8fff'
                              queryIndex: 0
                            - colorMode: fixed
                              colorValue: '#EE6C6C'
                              queryIndex: 1
                            - colorMode: fixed
                              colorValue: '#643535'
                              queryIndex: 2
                            - colorMode: fixed
                              colorValue: '#FFCC00'
                              queryIndex: 3
                        yAxis:
                            format:
                                unit: bytes
                            label: ""
                            min: 0
                            show: true
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: sum(kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                seriesNameFormat: Node memory capacity
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    sum(node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    sum(node_memory_MemAvailable_bytes{instance=~"$node"})
                                seriesNameFormat: Utilization - Node memory utilization (with virt)
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    sum(node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    sum(node_memory_MemAvailable_bytes{instance=~"$node"})
                                    -
                                    sum(kubevirt_vmi_memory_used_bytes{node=~"$node"})
                                seriesNameFormat: Utilization - Node memory utilization (without virt)
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    (
                                    sum(kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum(kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    +
                                    sum(kube_pod_resource_request{resource="memory", node=~"$node"})
                                seriesNameFormat: Plan - Memory requests
        Utilization-Node:
            kind: Panel
            spec:
                display:
                    name: Utilization - Actual overcommit level
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        legend:
                            position: bottom
                        thresholds:
                            steps:
                                - color: '#FFB249'
                                  value: 0.8
                                - color: '#EE6C6C'
                                  value: 0.9
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    (
                                    label_replace((
                                    (node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    (node_memory_MemAvailable_bytes{instance=~"$node"})
                                    ), "node", "$1", "instance", "(.+)")
                                    - on (node)
                                    (
                                    sum by (node) (kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum by (node) (kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    )

                                    / on (node)

                                    (
                                    (kube_node_status_allocatable{resource="memory"} * on (node) kube_node_role{role="worker"})
                                    )
                                seriesNameFormat: '{{node}}'
        Utilization-Node-1:
            kind: Panel
            spec:
                display:
                    name: Utilization - Utilization of reserved system memory
                    description: This graph is showing the utilization of the hypervisor system reserved memory. The utilization must stay below 100%, otherwise the hypervisor is using more memory for system processes then what was reserved. This is putting system processes at risk.
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        legend:
                            position: bottom
                        thresholds:
                            steps:
                                - value: 0.9
                                - color: '#EE6C6C'
                                  value: 1
                        yAxis:
                            format:
                                unit: percent-decimal
                            label: ""
                            show: true
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                minStep: ""
                                query: |-
                                    topk(5, (
                                    sum by (node) (container_memory_rss{id="/system.slice"})

                                    / on (node)

                                    (
                                    sum by (node) (kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum by (node) (kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    ))
                                seriesNameFormat: '{{node}}'
        Utilization-Node-2:
            kind: Panel
            spec:
                display:
                    name: Plan - Pod requests
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        legend:
                            position: bottom
                        thresholds:
                            steps:
                                - color: '#FFB249'
                                  value: 0.8
                                - color: '#EE6C6C'
                                  value: 0.9
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    sum by (node) (kube_pod_resource_request{resource="memory", node=~"$node"})

                                    / on (node)

                                    (
                                    (kube_node_status_allocatable{resource="memory"} * on (node) kube_node_role{role="worker"})
                                    )
                                seriesNameFormat: '{{node}}'
        UtilizationDsitribution:
            kind: Panel
            spec:
                display:
                    name: Plan - Virtual memory overcommit level
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        legend:
                            position: bottom
                        thresholds:
                            steps:
                                - value: 0.9
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    (
                                    (
                                    label_replace((
                                    (node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    (node_memory_MemAvailable_bytes{instance=~"$node"})
                                    ), "node", "$1", "instance", "(.+)")
                                    - on (node)
                                    (
                                    sum by (node) (kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum by (node) (kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    )
                                    +
                                    sum by (node) (kubevirt_vmi_memory_domain_bytes)
                                    )


                                    /

                                    (kube_node_status_allocatable{resource="memory"} * on (node) kube_node_role{role="worker"})
                                seriesNameFormat: '{{node}}'
        UtilizationMinmax:
            kind: Panel
            spec:
                display:
                    name: Node Utilization - min/max
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last-number
                        format:
                            unit: decimal
                        sparkline: {}
                        thresholds:
                            steps:
                                - value: 0.7
                                - color: '#FF9F1C'
                                  value: 0.8
                                - color: '#EA4747'
                                  value: 0.9
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    bottomk(1, min by (node) ((
                                    label_replace((
                                    (node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    (node_memory_MemAvailable_bytes{instance=~"$node"})
                                    ), "node", "$1", "instance", "(.+)")
                                    - on (node)
                                    (
                                    sum by (node) (kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum by (node) (kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    )

                                    / on (node)

                                    (
                                    (kube_node_status_allocatable{resource="memory"} * on (node) kube_node_role{role="worker"})
                                    )
                                    ))
                                seriesNameFormat: Min - {{node}}
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    topk(1, max by (node) ((
                                    label_replace((
                                    (node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    (node_memory_MemAvailable_bytes{instance=~"$node"})
                                    ), "node", "$1", "instance", "(.+)")
                                    - on (node)
                                    (
                                    sum by (node) (kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum by (node) (kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    )

                                    / on (node)

                                    (
                                    (kube_node_status_allocatable{resource="memory"} * on (node) kube_node_role{role="worker"})
                                    )
                                    ))
                                seriesNameFormat: Max - {{node}}
        UtilizationOverCommitLevel:
            kind: Panel
            spec:
                display:
                    name: Cluster Utilization
                    description: Current aggregate utilization of the cluster
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last-number
                        format:
                            unit: percent-decimal
                        sparkline: {}
                        thresholds:
                            steps:
                                - value: 0.7
                                - color: '#FF9F1C'
                                  value: 0.8
                                - color: '#EA4747'
                                  value: 0.9
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    (
                                    sum(node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    sum(node_memory_MemAvailable_bytes{instance=~"$node"})
                                    -
                                    (
                                    sum(kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum(kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    )

                                    /

                                    (
                                    sum(kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                seriesNameFormat: Physical Memory utilization
        UtilizationOverCommitLevel-1:
            kind: Panel
            spec:
                display:
                    name: Utilization Level
                    description: Utilization level based on the current utilization of the cluster
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last-number
                        format:
                            unit: percent-decimal
                        mappings:
                            - kind: Range
                              spec:
                                from: 0.8
                                result:
                                    color: '#FFCC00'
                                    value: ""
                        sparkline: {}
                        thresholds:
                            steps:
                                - value: 0.8
                                - color: '#EE6C6C'
                                  value: 0.9
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    (
                                    sum(node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    sum(node_memory_MemAvailable_bytes{instance=~"$node"})
                                    -
                                    (
                                    sum(kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum(kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    )

                                    /

                                    (
                                    sum(kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                seriesNameFormat: Utilization - Actual Overcommit Level
        Virtualmemoryallocation:
            kind: Panel
            spec:
                display:
                    name: Virtual Memory assignment
                    description: The virtual memory assignment is showing the worst-case scenario if all virtual memory was used right now. The assigned virtual memory is shown on top of the non virtualization related memory utilization. The current utiliztaion plus worst-case virtual memory utilization is indiacting the worst case memor overcommittment.
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        legend:
                            position: bottom
                        querySettings:
                            - colorMode: fixed
                              colorValue: '#8f8fff'
                              queryIndex: 0
                            - colorMode: fixed
                              colorValue: '#FFCC00'
                              queryIndex: 1
                            - colorMode: fixed
                              colorValue: '#7c6400'
                              queryIndex: 2
                        thresholds:
                            mode: percent
                            steps: []
                        visual:
                            areaOpacity: 0
                            connectNulls: false
                            display: line
                            lineWidth: 1.25
                            pointRadius: 2.75
                        yAxis:
                            format:
                                unit: bytes
                            label: ""
                            min: 0
                            show: true
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                minStep: ""
                                query: sum(kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                seriesNameFormat: Node capacity
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    sum(node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    sum(node_memory_MemAvailable_bytes{instance=~"$node"})
                                    -
                                    (
                                    sum(kube_node_status_capacity{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    -
                                    sum(kube_node_status_allocatable{resource="memory", node=~"$node"} * on (node) kube_node_role{role="worker", node=~"$node"})
                                    )
                                    +
                                    sum(kubevirt_vmi_memory_domain_bytes{node=~"$node"})
                                seriesNameFormat: Plan - VM assigned virtual memory
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                query: |-
                                    sum(node_memory_MemTotal_bytes{instance=~"$node"})
                                    -
                                    sum(node_memory_MemAvailable_bytes{instance=~"$node"})
                                    -
                                    sum(kubevirt_vmi_memory_used_bytes{node=~"$node"})
                                seriesNameFormat: Utilization - Node memory utilization (without virt)
    layouts:
        - kind: Grid
          spec:
            display:
                title: Summary - Plan & Utilization
                collapse:
                    open: true
            items:
                - x: 0
                  "y": 7
                  width: 18
                  height: 7
                  content:
                    $ref: '#/spec/panels/MemoryPlanAndUtilization'
                - x: 4
                  "y": 0
                  width: 4
                  height: 7
                  content:
                    $ref: '#/spec/panels/OverCommitLevel'
                - x: 0
                  "y": 0
                  width: 4
                  height: 7
                  content:
                    $ref: '#/spec/panels/UtilizationOverCommitLevel'
                - x: 8
                  "y": 0
                  width: 2
                  height: 7
                  content:
                    $ref: '#/spec/panels/SystemExceedsResevration'
                - x: 12
                  "y": 0
                  width: 6
                  height: 7
                  content:
                    $ref: '#/spec/panels/UtilizationMinmax'
        - kind: Grid
          spec:
            display:
                title: Cluster - Plan & utilization - Detailed
                collapse:
                    open: false
            items:
                - x: 0
                  "y": 0
                  width: 14
                  height: 7
                  content:
                    $ref: '#/spec/panels/Utilization'
                - x: 14
                  "y": 0
                  width: 4
                  height: 7
                  content:
                    $ref: '#/spec/panels/UtilizationOverCommitLevel-1'
                - x: 14
                  "y": 7
                  width: 4
                  height: 7
                  content:
                    $ref: '#/spec/panels/OverCommitLevel-1'
                - x: 0
                  "y": 7
                  width: 14
                  height: 7
                  content:
                    $ref: '#/spec/panels/Virtualmemoryallocation'
                - x: 0
                  "y": 14
                  width: 14
                  height: 3
                  content:
                    $ref: '#/spec/panels/Pressure'
        - kind: Grid
          spec:
            display:
                title: Nodes - Plan & Utilization
                collapse:
                    open: false
            items:
                - x: 0
                  "y": 0
                  width: 14
                  height: 8
                  content:
                    $ref: '#/spec/panels/Utilization-Node'
                - x: 14
                  "y": 0
                  width: 4
                  height: 8
                  content:
                    $ref: '#/spec/panels/UtilizationMinmax'
                - x: 0
                  "y": 8
                  width: 14
                  height: 8
                  content:
                    $ref: '#/spec/panels/Utilization-Node-2'
                - x: 14
                  "y": 8
                  width: 4
                  height: 8
                  content:
                    $ref: '#/spec/panels/PlanMinmax'
                - x: 0
                  "y": 16
                  width: 14
                  height: 8
                  content:
                    $ref: '#/spec/panels/UtilizationDsitribution'
                - x: 0
                  "y": 24
                  width: 14
                  height: 6
                  content:
                    $ref: '#/spec/panels/Pressure-1'
        - kind: Grid
          spec:
            display:
                title: System
                collapse:
                    open: false
            items:
                - x: 0
                  "y": 0
                  width: 14
                  height: 8
                  content:
                    $ref: '#/spec/panels/Utilization-Node-1'
                - x: 21
                  "y": 0
                  width: 2
                  height: 8
                  content:
                    $ref: '#/spec/panels/SystemExceedsResevration'
                - x: 14
                  "y": 0
                  width: 7
                  height: 8
                  content:
                    $ref: '#/spec/panels/SystemMinmax'
    duration: 1h

